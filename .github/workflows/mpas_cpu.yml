name: Setup Build and Run MPAS CI/CD

on:
    push:
        branches:
            - mpas_cicd
    pull_request:
        branches:
            - mpas_cicd

jobs:
    setup:
        name: Install MPAS Libraries
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Check MPI & Fortran
            run: |
              sudo apt-get update
              sudo apt-get install -y mpich
              echo "MPI version:"
              mpicc --version
              echo "Fortran version:"
              gfortran --version

          - name: Install Zlib & HDF5
            run: |
              sudo apt-get install -y zlib1g-dev libhdf5-mpi-dev

          - name: Set up NetCDF-C
            run: |
              sudo apt-get install -y libnetcdf-dev

          - name: Set up NetCDF-Fortran
            run: |
              sudo apt-get install -y libnetcdff-dev

          - name: Set up PIO
            run: |
              sudo apt-get install -y libpnetcdf-dev

         # - name: Download I/O libraries
         #   run: |
         #     mkdir -p sources
         #     chmod +x src/tools/download_io_libraries.sh
         #     ./src/tools/download_io_libraries.sh

          - name: Set up Fortran compiler
            run: |
              sudo apt-get update
              sudo apt-get install -y gfortran

          - name: Install dependencies
            run: |
              sudo apt-get update
              sudo apt-get install -y build-essential mpich
          

    build:
        name: Build MPAS
        runs-on: ubuntu-latest
        needs: setup

        steps:
          - name: Build MPAS
            run: |
              cd src
              make clean
              make gfortran CORE=atmosphere

    test:
      name: Run Tests
      runs-on: ubuntu-latest
      needs: build

      steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Run MPAS model
          run: |
            cd src
            mpirun -np 4 ./atmosphere_model